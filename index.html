<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeScope Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#0f172a",
                        accent: "#0d9488",
                        highlight: "#f97316",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                },
            },
        };
    </script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 font-display transition-colors duration-300 min-h-screen">

<!-- Header -->
<header class="bg-gradient-to-r from-slate-900 via-blue-950 to-slate-900 shadow-xl text-white pb-20 pt-10 px-6">
    <div class="max-w-7xl mx-auto flex flex-col items-center justify-center space-y-6">
        <div class="flex items-center space-x-3">
            <span class="material-symbols-outlined text-4xl text-teal-400">analytics</span>
            <h1 class="text-3xl font-bold tracking-tight text-center">TradeScope Dashboard</h1>
        </div>

        <!-- File Upload Section -->
        <div class="bg-white/5 backdrop-blur-md rounded-xl p-2 flex items-center space-x-2 border border-white/10">
            <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
            <label for="fileInput" class="bg-white text-slate-900 hover:bg-slate-50 px-6 py-2.5 rounded-lg font-medium shadow-sm transition-all flex items-center space-x-2 cursor-pointer">
                <span class="material-symbols-outlined text-sm">upload_file</span>
                <span>Choose Excel File</span>
            </label>
            <button id="processBtn" disabled class="bg-teal-600 hover:bg-teal-500 text-white px-6 py-2.5 rounded-lg font-medium transition-all flex items-center space-x-2 shadow-lg shadow-teal-900/20 disabled:bg-slate-600 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined text-sm">settings_motion_mode</span>
                <span>Process Data</span>
            </button>
        </div>

        <!-- File Name Display -->
        <p id="fileNameDisplay" class="text-slate-300 text-sm font-medium bg-slate-800/50 px-4 py-1 rounded-full border border-slate-700/50 hidden">
            Selected: <span id="fileName" class="font-bold text-white"></span>
        </p>

        <!-- Loading Indicator -->
        <div id="loading" class="text-white text-sm font-medium bg-teal-600/50 px-4 py-2 rounded-full border border-teal-500/50 hidden">
            ⏳ Processing data...
        </div>

        <!-- Dark Mode Toggle -->
        <button id="darkModeToggle" class="absolute top-6 right-6 bg-white/10 hover:bg-white/20 p-2 rounded-lg transition-all">
            <span class="material-symbols-outlined">dark_mode</span>
        </button>
    </div>
</header>

<!-- Error Message -->
<div id="errorMessage" class="max-w-7xl mx-auto px-4 mt-4 hidden">
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-800 dark:text-red-200"></div>
</div>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-12 space-y-8 pb-20" id="mainContent" style="display: none;">

    <!-- Title Section -->
    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-6">
        <h2 id="titleText" class="text-xl font-bold text-center text-slate-800 dark:text-white flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-teal-600">table_chart</span>
            Top 5 HS Codes in India's exports to Country
        </h2>
    </section>

    <!-- Top N Selector -->
    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <label for="topNSelector" class="text-sm font-medium text-slate-700 dark:text-slate-300">
                Show Top:
            </label>
            <select id="topNSelector" class="bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 px-4 py-2 cursor-pointer">
                <option value="5" selected>5 Products</option>
                <option value="10">10 Products</option>
                <option value="15">15 Products</option>
                <option value="20">20 Products</option>
                <option value="25">25 Products</option>
                <option value="30">30 Products</option>
            </select>
        </div>
        <div class="text-xs text-slate-500 dark:text-slate-400">
            <span class="material-symbols-outlined text-base align-middle">info</span>
            Updates table, bar chart, and breakdown
        </div>
    </section>

    <!-- Configure Filters Section (Optional) -->
    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-6">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-teal-600 text-2xl">tune</span>
                <div>
                    <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">Configure Filters</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Optional: Upload HS codes to filter products</p>
                </div>
            </div>
            <span class="text-xs font-semibold uppercase tracking-wider text-slate-500 bg-slate-100 dark:bg-slate-800 px-2.5 py-1 rounded-md">Optional</span>
        </div>

        <div class="flex items-center gap-4">
            <label for="filterFileInput" class="cursor-pointer flex items-center gap-2 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 py-2 px-4 rounded-lg text-sm font-medium border border-slate-200 dark:border-slate-600 transition-all">
                <span class="material-symbols-outlined text-lg">upload</span>
                Upload Filter CSV
                <input type="file" id="filterFileInput" accept=".csv" class="hidden">
            </label>

            <div id="filterStatus" class="hidden flex items-center gap-2 text-sm">
                <span class="material-symbols-outlined text-teal-600 text-lg">check_circle</span>
                <span class="text-slate-700 dark:text-slate-300">
                    <span id="filterFileName"></span>
                    (<span id="filterCount"></span> codes)
                </span>
                <button id="clearFilter" class="text-red-500 hover:text-red-600 ml-2">
                    <span class="material-symbols-outlined text-lg">close</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Table Section -->
    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table id="dataTable" class="w-full text-left text-sm">
                <thead class="bg-slate-50 dark:bg-slate-700 text-slate-600 dark:text-slate-300 uppercase tracking-wider font-semibold">
                    <tr>
                        <th class="px-6 py-4">HSCODE</th>
                        <th class="px-6 py-4 w-1/2">Description</th>
                        <th class="px-6 py-4 text-right">
                            <span id="tableTradeLabel">Exports Value</span>
                            <span class="normal-case text-xs opacity-70 block">(<span id="tableYear">2024</span> USD Million)</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
            </table>
        </div>
    </section>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Bar Chart -->
        <section class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-6">
            <div id="barChart" class="w-full h-[500px]"></div>
        </section>

        <!-- Donut Chart -->
        <section class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-6">
            <div id="donutChart" class="w-full h-[500px]"></div>
        </section>
    </div>

    <!-- Top 5 Breakdown Chart -->
    <section class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-8">
        <div id="top5Chart" class="w-full h-[300px]"></div>
    </section>

</main>

<script>
    console.log('[APP] Starting...');

    // TradeScope Product Codes (437 codes) - Reference only, not used by default
    const TRADESCOPE_CODES = [
        "84021200", "84021910", "84021920", "84021990", "84029020", "84041000", "84049000",
        "84122990", "84194010", "84194020", "84194090", "84198910", "84198911", "84198919",
        "84198920", "84198930", "84198940", "84198950", "84198960", "84198970", "84198980",
        "84198990", "84213910", "84261100", "84261200", "84261900", "84262000", "84263000",
        "84264100", "84264900", "84269910", "84269990", "84279000", "84282011", "84289090",
        "84291110", "84291120", "84291910", "84291920", "84292000", "84293000", "84294010",
        "84294020", "84294030", "84295100", "84295200", "84295900", "84301010", "84301020",
        "84302000", "84303110", "84303120", "84303190", "84303900", "84304110", "84304120",
        "84304130", "84304190", "84304900", "84305010", "84305090", "84312010", "84314100",
        "84314200", "84314310", "84314390", "84314910", "84314920", "84314930", "84314940",
        "84314990", "84329010", "84329090", "84331110", "84331190", "84336010", "84336020",
        "84339000", "84341000", "84342000", "84349010", "84349020", "84351000", "84359000",
        "84361000", "84362100", "84362900", "84368010", "84368090", "84369100", "84369900",
        "84371000", "84378010", "84378020", "84378090", "84379010", "84379020", "84379090",
        "84381020", "84382000", "84383010", "84383090", "84384000", "84385000", "84386000",
        "84388010", "84388020", "84388030", "84388040", "84388090", "84389010", "84389090",
        "84401010", "84401090", "84409000", "84411010", "84411090", "84412000", "84413000",
        "84425010", "84425020", "84425031", "84425039", "84425040", "84425050", "84425090",
        "84431100", "84431200", "84431300", "84431400", "84431500", "84431600", "84431700",
        "84431910", "84431920", "84431930", "84431941", "84431949", "84431990", "84439100",
        "84440010", "84440090", "84451110", "84451190", "84451210", "84451290", "84451300",
        "84451910", "84451920", "84451930", "84451940", "84451950", "84451960", "84451990",
        "84452011", "84452012", "84452013", "84452014", "84452019", "84452020", "84452030",
        "84452040", "84452050", "84452090", "84453011", "84453019", "84453020", "84453030",
        "84453040", "84453050", "84453090", "84454010", "84454020", "84454030", "84454040",
        "84454050", "84454090", "84459000", "84461011", "84461012", "84461019", "84461090",
        "84462110", "84462190", "84462910", "84462990", "84463011", "84463012", "84463019",
        "84463090", "84471111", "84471119", "84471120", "84471190", "84471211", "84471219",
        "84471220", "84471290", "84472010", "84472020", "84472030", "84472090", "84479010",
        "84479020", "84479030", "84481110", "84481190", "84481900", "84482000", "84483100",
        "84483210", "84483220", "84483230", "84483240", "84483290", "84483310", "84483320",
        "84483330", "84483340", "84483390", "84483910", "84483920", "84483990", "84484210",
        "84484220", "84484290", "84484910", "84484920", "84484930", "84484940", "84484950",
        "84484990", "84485110", "84485120", "84485130", "84485190", "84485900", "84490010",
        "84490090", "84511010", "84511090", "84514011", "84514019", "84514021", "84514029",
        "84514091", "84514099", "84515000", "84518011", "84518019", "84518021", "84518022",
        "84518029", "84518090", "84519000", "84561100", "84561200", "84562000", "84563000",
        "84564000", "84565000", "84569010", "84569020", "84569090", "84571010", "84571020",
        "84572010", "84572020", "84572090", "84573010", "84573020", "84573090", "84581100",
        "84581911", "84581912", "84581913", "84581919", "84581990", "84589100", "84589910",
        "84589920", "84589931", "84589932", "84589933", "84589934", "84589935", "84589941",
        "84589942", "84589943", "84589951", "84589959", "84589990", "84591000", "84592100",
        "84592910", "84592920", "84592930", "84592940", "84592950", "84592990", "84593100",
        "84593910", "84593990", "84594110", "84594120", "84594130", "84594190", "84594910",
        "84594920", "84594930", "84594990", "84595110", "84595120", "84595130", "84595190",
        "84595910", "84595920", "84595930", "84595940", "84595950", "84595990", "84596110",
        "84596190", "84596910", "84596920", "84596930", "84596940", "84596990", "84597010",
        "84597020", "84601200", "84601900", "84602200", "84602300", "84602400", "84602910",
        "84602920", "84602930", "84602940", "84602990", "84603100", "84603910", "84603990",
        "84604011", "84604012", "84604013", "84604019", "84604020", "84609010", "84609090",
        "84612011", "84612019", "84612020", "84613010", "84613020", "84613090", "84614011",
        "84614012", "84614013", "84614014", "84614019", "84614021", "84614022", "84614023",
        "84614024", "84614025", "84614026", "84614029", "84615011", "84615012", "84615013",
        "84615014", "84615015", "84615019", "84615021", "84615029", "84619000", "84631010",
        "84631020", "84631030", "84631090", "84632000", "84633010", "84633020", "84633030",
        "84633040", "84639010", "84639020", "84639030", "84639090", "84641010", "84641090",
        "84642000", "84649000", "84661010", "84661020", "84662000", "84663010", "84663020",
        "84663090", "84669100", "84669200", "84669310", "84669390", "84669400", "84741090",
        "84742090", "84743110", "84771000", "84772000", "84773000", "84774000", "84775100",
        "84775900", "84778010", "84778090", "84779000", "84781010", "84791000", "84798200",
        "84798999", "84799010", "84799020", "84799090", "84804100", "84804900", "84807100",
        "84807900", "84834000", "84839000", "85044010", "85044090", "85371000", "85372000",
        "87041010", "87054000", "87059000"
    ];

    let uploadedFile = null;
    let processedData = {
        cleanedData: null,
        filteredData: null,
        countryName: null,
        latestCol: null,
        year: null,
        tradeType: null
    };
    let selectedTopN = 5; // Default to 5
    let filterCodes = null; // null = no filtering, array = filter by these codes
    let filterFileName = null;

    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);
        darkModeToggle.querySelector('span').textContent = isDark ? 'light_mode' : 'dark_mode';
    });

    // Load dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
        darkModeToggle.querySelector('span').textContent = 'light_mode';
    }

    // Top N Selector change handler
    document.getElementById('topNSelector').addEventListener('change', function(e) {
        selectedTopN = parseInt(e.target.value);
        console.log('[TOP_N_SELECTOR] Changed to:', selectedTopN);

        // Re-render all affected components
        if (processedData.filteredData) {
            renderDashboard();
        }
    });

    // Filter CSV upload handler
    document.getElementById('filterFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        console.log('[FILTER_UPLOAD] Reading filter CSV:', file.name);

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const text = event.target.result;
                const lines = text.split(/\r?\n/).filter(line => line.trim());

                // Parse CSV - assume single column, skip header if present
                const codes = [];
                lines.forEach((line, idx) => {
                    const trimmed = line.trim().replace(/['"]/g, ''); // Remove quotes
                    // Skip header row if it looks like text
                    if (idx === 0 && isNaN(trimmed)) {
                        console.log('[FILTER_UPLOAD] Skipping header row:', trimmed);
                        return;
                    }
                    if (trimmed) {
                        codes.push(trimmed);
                    }
                });

                if (codes.length === 0) {
                    alert('No valid HS codes found in CSV file');
                    return;
                }

                filterCodes = codes;
                filterFileName = file.name;

                console.log('[FILTER_UPLOAD] Loaded filter codes:', codes.length);

                // Update UI
                document.getElementById('filterFileName').textContent = file.name;
                document.getElementById('filterCount').textContent = codes.length;
                document.getElementById('filterStatus').classList.remove('hidden');

                // Re-render dashboard if data is already loaded
                if (uploadedFile && processedData.cleanedData) {
                    processFile(uploadedFile); // Re-process with new filter
                }

            } catch (error) {
                console.error('[FILTER_UPLOAD] Error:', error);
                alert('Error reading filter CSV: ' + error.message);
            }
        };

        reader.readAsText(file);
    });

    // Clear filter handler
    document.getElementById('clearFilter').addEventListener('click', function() {
        filterCodes = null;
        filterFileName = null;
        document.getElementById('filterFileInput').value = '';
        document.getElementById('filterStatus').classList.add('hidden');

        console.log('[FILTER_UPLOAD] Filter cleared');

        // Re-render dashboard if data is already loaded
        if (uploadedFile && processedData.cleanedData) {
            processFile(uploadedFile); // Re-process without filter
        }
    });

    // File upload handling
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileNameDisplay').classList.remove('hidden');
            document.getElementById('processBtn').disabled = false;
        }
    });

    // Process button click
    document.getElementById('processBtn').addEventListener('click', function() {
        console.log('[PROCESS_BTN] Click event fired');
        if (!uploadedFile) {
            console.error('[PROCESS_BTN] No file uploaded');
            return;
        }

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('processBtn').disabled = true;

        setTimeout(() => {
            try {
                console.log('[PROCESS_BTN] Calling processFile...');
                processFile(uploadedFile);
            } catch (error) {
                console.error('[PROCESS_BTN] CRITICAL ERROR:', error);
                console.error('[PROCESS_BTN] Stack:', error.stack);
                showError('Error: ' + error.message + ' (Check console F12)');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('processBtn').disabled = false;
            }
        }, 100);
    });

    function processFile(file) {
        console.log('[PROCESS_FILE] Starting...');
        console.log('[PROCESS_FILE] File name:', file.name);
        console.log('[PROCESS_FILE] File size:', file.size);

        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                console.log('[PROCESS_FILE] File loaded, parsing Excel...');
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                console.log('[PROCESS_FILE] Workbook sheets:', workbook.SheetNames);

                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                const rawData = XLSX.utils.sheet_to_json(firstSheet, {
                    header: 1,
                    defval: null,
                    raw: false
                });
                console.log('[PROCESS_FILE] Raw data rows:', rawData.length);
                console.log('[PROCESS_FILE] First 3 rows:', rawData.slice(0, 3));

                const dataRows = rawData.slice(10);
                console.log('[PROCESS_FILE] After skipping 10 rows:', dataRows.length);

                console.log('[PROCESS_FILE] Calling cleanMultiIndexColumns...');
                const cleaned = cleanMultiIndexColumns(dataRows);
                console.log('[PROCESS_FILE] Cleaned data rows:', cleaned.length);
                processedData.cleanedData = cleaned;

                // Apply filter if configured, otherwise use all cleaned data
                let filtered;
                if (filterCodes && filterCodes.length > 0) {
                    console.log('[PROCESS_FILE] Applying custom filter with', filterCodes.length, 'codes...');
                    filtered = cleaned.filter(row =>
                        filterCodes.includes(String(row.product_code))
                    );
                    console.log('[PROCESS_FILE] Filtered products:', filtered.length);
                } else {
                    console.log('[PROCESS_FILE] No filter applied, using all products:', cleaned.length);
                    filtered = cleaned;
                }
                processedData.filteredData = filtered;

                if (filtered.length === 0) {
                    const errorMsg = filterCodes
                        ? `No products matching your filter codes found in the data (${filterCodes.length} codes in filter)`
                        : 'No valid products found in the data';
                    throw new Error(errorMsg);
                }

                const columns = Object.keys(cleaned[0]);
                console.log('[PROCESS_FILE] Calling detectCountryAndYear...');
                const detection = detectCountryAndYear(columns);
                console.log('[PROCESS_FILE] Detection result:', detection);
                processedData.countryName = detection.countryName;
                processedData.latestCol = detection.latestCol;
                processedData.year = detection.year;
                processedData.tradeType = detection.tradeType;

                console.log('[PROCESS_FILE] Rendering dashboard...');
                renderDashboard();

                document.getElementById('loading').classList.add('hidden');
                console.log('[PROCESS_FILE] Complete!');
            } catch (error) {
                console.error('[PROCESS_FILE] ERROR:', error);
                console.error('[PROCESS_FILE] Stack:', error.stack);
                document.getElementById('loading').classList.add('hidden');
                showError('Error: ' + error.message + ' (Check console F12)');
                document.getElementById('processBtn').disabled = false;
            }
        };

        reader.onerror = function(error) {
            console.error('[PROCESS_FILE] File reader error:', error);
            document.getElementById('loading').classList.add('hidden');
            showError('Error reading file (Check console F12)');
            document.getElementById('processBtn').disabled = false;
        };

        reader.readAsArrayBuffer(file);
    }

    function cleanMultiIndexColumns(rawData) {
        console.log('[CLEAN_COLUMNS] Starting...');

        if (!rawData || rawData.length < 2) {
            console.error('[CLEAN_COLUMNS] Invalid data structure');
            throw new Error('Invalid data structure');
        }

        const headerRow1 = rawData[0] || [];
        const headerRow2 = rawData[1] || [];
        const dataRows = rawData.slice(2);

        console.log('[CLEAN_COLUMNS] Header row 1:', headerRow1);
        console.log('[CLEAN_COLUMNS] Header row 2:', headerRow2);

        // Forward-fill headerRow1
        const filledRow1 = [];
        let lastValue = null;
        for (let val of headerRow1) {
            if (val !== null && val !== undefined && val !== '') {
                lastValue = val;
            }
            filledRow1.push(lastValue);
        }
        console.log('[CLEAN_COLUMNS] Filled header row 1:', filledRow1);

        // Build column names
        const columnNames = [];
        for (let i = 0; i < Math.max(headerRow1.length, headerRow2.length); i++) {
            const part1 = normalizeText(filledRow1[i]);
            const part2 = normalizeText(headerRow2[i]);

            const parts = [];
            if (part1 && !part1.includes('unnamed')) parts.push(part1);
            if (part2 && !part2.includes('unnamed')) parts.push(part2);

            if (parts.length === 0) {
                columnNames.push(null);
                continue;
            }

            const yearMatch = parts.join(' ').match(/\b\d{4}\b/);
            const year = yearMatch ? yearMatch[0] : null;

            let label = null;
            for (let p of parts) {
                if (/\b\d{4}\b/.test(p)) continue;
                if (p.startsWith('value in') || p === 'value') continue;
                label = p;
                break;
            }

            if (year && label) {
                columnNames.push(slugify(label) + '_' + year);
            } else if (year) {
                columnNames.push('year_' + year);
            } else {
                columnNames.push(slugify(parts.join(' ')));
            }
        }

        console.log('[CLEAN_COLUMNS] Generated column names:', columnNames);

        let codeIdx = -1, labelIdx = -1;
        for (let i = 0; i < columnNames.length; i++) {
            if (columnNames[i]) {
                if (codeIdx === -1) codeIdx = i;
                else if (labelIdx === -1) { labelIdx = i; break; }
            }
        }

        if (codeIdx !== -1) columnNames[codeIdx] = 'product_code';
        if (labelIdx !== -1) columnNames[labelIdx] = 'product_label';

        console.log('[CLEAN_COLUMNS] Final column names:', columnNames);

        const result = [];
        for (let row of dataRows) {
            if (!row || row.every(cell => !cell)) continue;

            const obj = {};
            let hasData = false;
            for (let i = 0; i < columnNames.length; i++) {
                if (columnNames[i]) {
                    let value = row[i];
                    if (columnNames[i] === 'product_code' && value) {
                        value = String(value).trim().replace(/^['"]|['"]$/g, '');
                    }
                    if (value !== null && value !== undefined && value !== '') {
                        hasData = true;
                    }
                    obj[columnNames[i]] = value;
                }
            }
            if (hasData) result.push(obj);
        }

        console.log('[CLEAN_COLUMNS] Complete!');
        return result;
    }

    function normalizeText(s) {
        if (!s) return null;
        const t = String(s).trim().toLowerCase();
        if (t === '' || t === 'nan' || t === 'null' || t === 'undefined') return null;
        return t.replace(/['''\"/\\\-–—,:;()]/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function slugify(s) {
        if (!s) return '';
        return s.replace(/[^0-9a-zA-Z\s]/g, '').replace(/\s+/g, '_').toLowerCase();
    }

    function detectCountryAndYear(columns) {
        console.log('[DETECT_COUNTRY] Starting...');

        let countrySlug = null;
        let latestCol = null;
        let year = null;

        const yearCols = columns.filter(c => /_\d{4}$/.test(c));
        console.log('[DETECT_COUNTRY] Columns ending with _YYYY:', yearCols);

        if (yearCols.length > 0) {
            const firstCol = yearCols[0];
            let tradeType = null;

            if (firstCol.includes('exports_to')) {
                tradeType = 'exports';
                countrySlug = firstCol.replace(/_\d{4}$/, '').replace(/.*exports_to_/, '');
            } else if (firstCol.includes('imports_from')) {
                tradeType = 'imports';
                countrySlug = firstCol.replace(/_\d{4}$/, '').replace(/.*imports_from_/, '');
            } else {
                countrySlug = firstCol.replace(/_\d{4}$/, '');
                tradeType = 'exports';
            }

            console.log('[DETECT_COUNTRY] Trade type:', tradeType);
            console.log('[DETECT_COUNTRY] Country slug:', countrySlug);

            const thisCountryCols = yearCols.filter(c => c.includes(countrySlug));
            latestCol = thisCountryCols.sort().pop();
            year = latestCol.match(/\d{4}$/)[0];

            const countryName = countrySlug
                .replace(/_/g, ' ')
                .split(' ')
                .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                .join(' ');

            const result = { countryName, latestCol, year, countrySlug, tradeType };
            console.log('[DETECT_COUNTRY] Complete! Result:', result);
            return result;
        }

        throw new Error('Could not detect country and year from data');
    }

    function renderDashboard() {
        const { cleanedData, filteredData, countryName, latestCol, year, tradeType } = processedData;

        // Update title with dynamic topN
        const tradeText = tradeType === 'exports' ? 'exports to' : 'imports from';
        document.getElementById('titleText').innerHTML = `
            <span class="material-symbols-outlined text-teal-600">table_chart</span>
            Top ${selectedTopN} HS Codes in India's ${tradeText} ${countryName}
        `;

        // Show main content
        document.getElementById('mainContent').style.display = 'block';

        // Sort filtered data
        const sorted = [...filteredData].sort((a, b) => {
            const aVal = parseFloat(a[latestCol]) || 0;
            const bVal = parseFloat(b[latestCol]) || 0;
            return bVal - aVal;
        });

        // Render components with dynamic topN
        renderTable(sorted.slice(0, selectedTopN), latestCol, year, tradeType);
        renderBarChart(sorted.slice(0, selectedTopN), latestCol, year, tradeType);

        const totalExports = cleanedData.reduce((sum, row) => sum + (parseFloat(row[latestCol]) || 0), 0);
        const hemtExports = filteredData.reduce((sum, row) => sum + (parseFloat(row[latestCol]) || 0), 0);

        renderDonutChart(totalExports, hemtExports, countryName, tradeType);
        renderTop5ShareChart(sorted, latestCol, year, tradeType);
    }

    function renderTable(data, latestCol, year, tradeType) {
        const tradeLabel = tradeType === 'exports' ? 'Exports Value' : 'Imports Value';
        document.getElementById('tableTradeLabel').textContent = tradeLabel;
        document.getElementById('tableYear').textContent = year;

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        data.forEach(row => {
            const value = parseFloat(row[latestCol]) || 0;
            const formatted = `$${(value / 1000).toFixed(2)}M`;

            tbody.innerHTML += `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                    <td class="px-6 py-4 font-mono font-medium text-slate-600 dark:text-slate-400">${row.product_code}</td>
                    <td class="px-6 py-4 text-slate-700 dark:text-slate-300">${row.product_label || ''}</td>
                    <td class="px-6 py-4 text-right font-bold text-teal-700 dark:text-teal-400">${formatted}</td>
                </tr>
            `;
        });
    }

    function renderBarChart(data, latestCol, year, tradeType) {
        const chartDom = document.getElementById('barChart');
        const myChart = echarts.init(chartDom);

        const hsCodes = data.map(d => d.product_code);
        const values = data.map(d => (parseFloat(d[latestCol]) || 0) / 1000);
        const labels = values.map(v => `$${v.toFixed(2)}M`);

        const tradeLabel = tradeType === 'exports' ? 'EXPORT' : 'IMPORT';

        const option = {
            title: {
                text: `TOP PRODUCTS ${tradeLabel} VALUES BY HS CODE`,
                left: 'center',
                top: 10,
                textStyle: { fontSize: 14, fontWeight: 'bold' }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' }
            },
            grid: {
                left: '10%',
                right: '15%',
                top: '20%',
                bottom: '10%'
            },
            xAxis: {
                type: 'value',
                name: `${tradeLabel} VALUE (${year} USD Million)`,
                nameLocation: 'middle',
                nameGap: 25,
                nameTextStyle: { fontSize: 11 }
            },
            yAxis: {
                type: 'category',
                data: hsCodes,
                inverse: true,
                axisLabel: { fontSize: 11 }
            },
            series: [{
                type: 'bar',
                data: values,
                itemStyle: { color: '#14b8a6' },
                label: {
                    show: true,
                    position: 'right',
                    formatter: (params) => labels[params.dataIndex],
                    fontSize: 11
                }
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    }

    function renderDonutChart(totalExports, hemtExports, countryName, tradeType) {
        const chartDom = document.getElementById('donutChart');
        const myChart = echarts.init(chartDom);

        const totalB = totalExports / 1_000_000;
        const hemtB = hemtExports / 1_000_000;
        const otherB = totalB - hemtB;
        const hemtPercent = (hemtB / totalB * 100).toFixed(2);

        const tradeLabel = tradeType === 'exports' ? 'EXPORTS TO' : 'IMPORTS FROM';

        // Dynamic label based on filter
        const filteredLabel = filterCodes
            ? `Filtered Products (${filterCodes.length} codes)`
            : 'All Products';

        const option = {
            title: {
                text: `${filteredLabel.toUpperCase()}'S SHARE OF INDIA'S ${tradeLabel} ${countryName.toUpperCase()}`,
                left: 'center',
                top: 10,
                textStyle: { fontSize: 12, fontWeight: 'bold' }
            },
            tooltip: {
                trigger: 'item',
                formatter: (params) => `${params.name}<br/>$${params.value.toFixed(2)}B (${params.percent.toFixed(1)}%)`
            },
            legend: {
                orient: 'horizontal',
                bottom: 20,
                left: 'center'
            },
            series: [{
                type: 'pie',
                radius: ['35%', '60%'],
                center: ['50%', '50%'],
                itemStyle: {
                    borderRadius: 8,
                    borderColor: '#fff',
                    borderWidth: 2
                },
                label: {
                    show: true,
                    formatter: (params) => params.name.includes('Products') ? `${params.name}\n$${params.value.toFixed(2)}B\n${params.percent.toFixed(1)}%` : '',
                    fontSize: 11,
                    fontWeight: 'bold'
                },
                data: [
                    {
                        value: hemtB,
                        name: filteredLabel,
                        itemStyle: { color: '#f97316' }
                    },
                    {
                        value: otherB,
                        name: 'Other Exports',
                        itemStyle: { color: '#e2e8f0' }
                    }
                ]
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    }

    function renderTop5ShareChart(sorted, latestCol, year, tradeType) {
        console.log('[TOP5_CHART] Starting...');

        const topN = sorted.slice(0, selectedTopN);
        const hemtTotal = sorted.reduce((sum, row) => sum + (parseFloat(row[latestCol]) || 0), 0);

        const colors = ['#1e40af', '#14b8a6', '#f97316', '#64748b', '#3b82f6', '#e2e8f0'];
        const tradeLabel = tradeType === 'exports' ? 'EXPORTS' : 'IMPORTS';
        const tradeLabelCapital = tradeType === 'exports' ? 'Export' : 'Import';

        const seriesArray = [];

        topN.forEach((row, idx) => {
            const value = (parseFloat(row[latestCol]) || 0) / 1000;

            // Use modulo for colors to support more than 6 products
            const colorIndex = idx % colors.length;

            seriesArray.push({
                name: row.product_code,
                type: 'bar',
                stack: 'total',
                data: [value],
                itemStyle: { color: colors[colorIndex] },
                label: {
                    show: true,
                    formatter: function(params) {
                        const percentage = ((params.value / (hemtTotal / 1000)) * 100).toFixed(1);
                        return `${percentage}%`;
                    },
                    fontSize: 10,
                    fontWeight: 'bold',
                    color: '#fff'
                },
                emphasis: {
                    focus: 'series'
                }
            });
        });

        const topNTotal = topN.reduce((sum, row) => sum + (parseFloat(row[latestCol]) || 0), 0);
        const othersTotal = hemtTotal - topNTotal;
        const othersValue = othersTotal / 1000;

        seriesArray.push({
            name: 'Other Products',
            type: 'bar',
            stack: 'total',
            data: [othersValue],
            itemStyle: { color: colors[5] },
            label: {
                show: true,
                formatter: function(params) {
                    const percentage = ((params.value / (hemtTotal / 1000)) * 100).toFixed(1);
                    return `${percentage}%`;
                },
                fontSize: 10,
                fontWeight: 'bold',
                color: '#333'
            },
            emphasis: {
                focus: 'series'
            }
        });

        const chartDom = document.getElementById('top5Chart');
        const myChart = echarts.init(chartDom);

        // Dynamic Y-axis label based on filter
        const yAxisLabel = filterCodes
            ? `Filtered Products (${filterCodes.length} codes)`
            : 'All Products';

        const option = {
            title: {
                text: `TOP ${selectedTopN} PRODUCTS BREAKDOWN OF TOTAL ${tradeLabel}`,
                left: 'center',
                top: 20,
                textStyle: { fontSize: 13, fontWeight: 'bold' }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function(params) {
                    let result = '';
                    let total = 0;
                    params.forEach(p => total += p.value);

                    params.forEach(param => {
                        const percentage = ((param.value / total) * 100).toFixed(1);
                        result += `${param.marker} ${param.seriesName}<br/>`;
                        result += `Value: $${param.value.toFixed(2)}M (${percentage}%)<br/><br/>`;
                    });
                    return result;
                }
            },
            legend: {
                bottom: 15,
                left: 'center',
                itemWidth: 15,
                itemHeight: 10,
                textStyle: { fontSize: 10 }
            },
            grid: {
                left: '10%',
                right: '10%',
                top: '80px',
                bottom: '80px',
                containLabel: true
            },
            xAxis: {
                type: 'value',
                name: `${tradeLabelCapital} Value (${year} USD Million)`,
                nameLocation: 'middle',
                nameGap: 30,
                nameTextStyle: { fontSize: 11 }
            },
            yAxis: {
                type: 'category',
                data: [yAxisLabel]
            },
            series: seriesArray
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());

        console.log('[TOP5_CHART] Complete!');
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.querySelector('div').textContent = message;
        errorDiv.classList.remove('hidden');
    }
</script>

</body>
</html>
